# =============================================================================
# tls-tunnel 客户端配置 - Nginx 反向代理模式
# =============================================================================
# 
# 使用场景：
# - 客户端通过 Nginx 反向代理连接到 tls-tunnel 服务端
# - Nginx 负责 TLS/SSL 终止和协议转换（HTTP/2 或 WebSocket）
# - 适用于生产环境部署，提供更好的安全性和灵活性
#
# 配套 Nginx 配置：examples/nginx-all-in-one.conf
# 配套服务端配置：examples/proxied-server.toml
#
# =============================================================================

[client]
# -----------------------------------------------------------------------------
# 服务器连接配置
# -----------------------------------------------------------------------------

# 服务器地址（Nginx 前端地址）
# - 可以是域名或 IP 地址
# - 示例：example.com, 192.168.1.100
server_addr = "localhost"

# 服务器端口（Nginx HTTPS 端口）
# - 通常为 443（HTTPS 标准端口）
server_port = 443

# 服务器路径（必须与 Nginx 配置中的 location 匹配）
# - 根目录模式：server_path = "/"
# - 子目录模式：server_path = "/tunnel/"（需以 / 结尾）
# - 必须与 Nginx 的 location 块配置一致
server_path = "/tunnel/"

# -----------------------------------------------------------------------------
# 传输协议配置
# -----------------------------------------------------------------------------

# 传输类型（必须与服务端配置一致）
# - "http2": HTTP/2 CONNECT 隧道（推荐，性能更好）
# - "wss": WebSocket Secure（兼容性更好）
# - "tls": 直连模式（不通过 Nginx，仅用于测试）
# 
# 注意：使用 Nginx 时，必须确保 Nginx 配置与此设置匹配
# - http2: 需要 proxy_set_header Connection ""
# - wss: 需要 proxy_set_header Upgrade/Connection "upgrade"
transport = "wss"

# -----------------------------------------------------------------------------
# TLS/SSL 配置
# -----------------------------------------------------------------------------

# 是否跳过 TLS 证书验证
# - true: 跳过验证（仅用于开发/测试环境）
# - false: 启用验证（生产环境必须使用）
skip_verify = true

# CA 证书路径（可选）
# - 当使用自签名证书时，指定 CA 证书文件路径
# - 启用 skip_verify = false 时，如果证书不是公共 CA 签发，需要配置此项
# ca_cert_path = "examples/certs/ca.pem"

# -----------------------------------------------------------------------------
# 认证配置
# -----------------------------------------------------------------------------

# 认证密钥（必须与服务器配置一致）
# - 用于客户端和服务端之间的身份验证
# - 生产环境请使用长度至少 32 字符的强密码
# - 建议使用随机生成的密钥：openssl rand -base64 32
auth_key = "test-secret-key-12345"

# =============================================================================
# 代理配置列表
# =============================================================================
# 
# 每个 [[proxies]] 块定义一个端口转发规则
# - name: 代理名称（用于日志标识，必须唯一）
# - publish_port: 服务端监听端口（外部访问该端口）
# - local_port: 客户端本地服务端口（转发到客户端本地的该端口）
#
# 工作流程：
# 外部访问 -> 服务端:publish_port -> 加密隧道 -> 客户端:local_port
#
# =============================================================================

# 示例 1: Web 服务代理
[[proxies]]
name = "web"                # 代理名称
publish_port = 8888         # 服务端监听 8888 端口
local_port = 80             # 转发到客户端本地 80 端口
# 使用：访问 http://server-ip:8888 -> 客户端本地 http://localhost:80

# 示例 2: SSH 服务代理
[[proxies]]
name = "ssh"                # SSH 服务
publish_port = 2222         # 服务端监听 2222 端口
local_port = 22             # 转发到客户端本地 22 端口
# 使用：ssh -p 2222 user@server-ip -> 客户端本地 ssh localhost:22

# 示例 3: 数据库代理
[[proxies]]
name = "database"           # 数据库服务
publish_port = 5432         # 服务端监听 5432 端口
local_port = 5432           # 转发到客户端本地 5432 端口
# 使用：psql -h server-ip -p 5432 -> 客户端本地数据库

# 示例 4: HTTPS 服务代理
# [[proxies]]
# name = "web-secure"
# publish_port = 8443
# local_port = 443
# 使用：https://server-ip:8443 -> 客户端本地 https://localhost:443

# 示例 5: 远程桌面代理
# [[proxies]]
# name = "rdp"
# publish_port = 3389
# local_port = 3389
# 使用：mstsc /v:server-ip:3389 -> 客户端本地 RDP

# 示例 6: 自定义应用
# [[proxies]]
# name = "custom-app"
# publish_port = 9000
# local_port = 8080

# =============================================================================
# 快速启动
# =============================================================================
#
# 1. 修改配置：
#    - 更新 server_addr（Nginx 服务器地址）
#    - 更新 auth_key（与服务端保持一致）
#    - 配置需要转发的端口（proxies 列表）
#
# 2. 确认 Nginx 已启动并正确配置
#
# 3. 确认服务端已启动：
#    tls-tunnel server -c examples/proxied-server.toml
#
# 4. 启动客户端：
#    tls-tunnel client -c examples/proxied-client.toml
#
# 5. 测试连接：
#    curl http://server-ip:8888
#    ssh -p 2222 user@server-ip
#
# =============================================================================
# 故障排查
# =============================================================================
#
# 问题 1: 连接失败
# - 检查 Nginx 是否正确运行：curl https://localhost/tunnel/
# - 检查服务端是否启动：netstat -an | findstr 8080
# - 检查防火墙规则是否允许相应端口
#
# 问题 2: 认证失败
# - 确认客户端和服务端的 auth_key 完全一致
# - 检查日志中的具体错误信息
#
# 问题 3: 证书错误
# - 开发环境：设置 skip_verify = true
# - 生产环境：使用有效证书或配置 ca_cert_path
#
# 问题 4: Nginx 502/504 错误
# - 确认服务端 behind_proxy = true
# - 检查 Nginx upstream 配置是否正确
# - 确认 transport 类型与 Nginx location 配置匹配
#
# 问题 5: WebSocket 升级失败（WSS 模式）
# - 确认 Nginx 配置包含 proxy_set_header Upgrade/Connection
# - 检查 nginx error.log 获取详细错误信息
#
# =============================================================================
