# TLS Tunnel - 客户端配置示例（提供 Proxy 给 Visitor 访问）
# 
# 此配置展示作为proxy提供者的客户端如何配置
# 使得其他客户端的 visitor 可以访问本客户端的服务

[client]
# 服务器地址和端口
server_addr = "your-server.com"
server_port = 8443

# 用于 TLS 验证的服务器名称
server_name = "your-server.com"

# 认证密钥（与服务器一致）
auth_key = "your-secret-key"

# 传输协议: tls, http2, wss
transport = "tls"

# 客户端名称（可选，用于日志）
name = "proxy-client"

# ============================================
# Proxy 配置（仅 Visitor 模式）
# ============================================
# 这些 proxy 仅供其他客户端的 visitor 访问
# 配置 publish_port 用于匹配，不配置 publish_addr（不在服务器监听端口）
# 服务器将这些 proxy 注册到全局注册表，visitor 通过 (name, publish_port) 查找

# 示例 1: MySQL 数据库代理
# 其他客户端的 visitor 通过 name = "mysql-proxy" + publish_port = 3306 匹配访问
[[proxies]]
name = "mysql-proxy"
type = "tcp"
local_port = 3306  # 本客户端本地的 MySQL 端口
publish_port = 3306  # 用于 visitor 匹配的标识符（此处使用标准 MySQL 端口）

# 关键：未配置 publish_addr
# - 服务器不会在 3306 端口监听
# - 外部无法通过服务器:3306 访问
# - 只能通过其他客户端的 visitor 模式访问


# 示例 2: Redis 代理
[[proxies]]
name = "redis-proxy"
type = "tcp"
local_port = 6379
publish_port = 6379


# 示例 3: 内部 API 代理
[[proxies]]
name = "internal-api-proxy"
type = "tcp"
local_port = 3000
publish_port = 3000


# 示例 4: PostgreSQL 代理
[[proxies]]
name = "postgres-proxy"
type = "tcp"
local_port = 5432
publish_port = 5432


# ============================================
# 混合模式：同时支持外部访问和 Visitor
# ============================================

# 混合模式 proxy：既对外开放，也支持 visitor 访问
[[proxies]]
name = "web-service"
type = "tcp"
local_port = 8000
publish_addr = "0.0.0.0"  # 配置后在服务器监听
publish_port = 8080  # 服务器监听端口，也用于 visitor 匹配
# 访问方式：
# 1. 外部直接访问：server_ip:8080 → 本客户端:8000
# 2. 其他客户端 visitor：name="web-service" + publish_port=8080

# 纯 Visitor 模式 proxy：仅供 visitor 访问
[[proxies]]
name = "admin-db"
type = "tcp"
local_port = 5433
publish_port = 5433  # 仅用于 visitor 匹配
# 未配置 publish_addr，服务器不监听 5433 端口
# 只能通过 visitor (name="admin-db", publish_port=5433) 访问


# ============================================
# 配置说明
# ============================================
# 
# Visitor 模式工作流程：
# 1. 本客户端（Proxy端）连接到服务器并发送 proxy 配置
# 2. 服务器将 proxy 注册到全局注册表，键为 (name, publish_port)
#    - 有 publish_addr：同时在服务器上绑定监听端口（外部可访问）
#    - 无 publish_addr：只注册，不监听端口（仅 visitor 可访问）
# 3. 其他客户端（Visitor端）配置 [[visitors]]，指定目标 name 和 publish_port
# 4. Visitor端的本地应用连接到 visitor 的 bind_port
# 5. Visitor端通过隧道向服务器发送：目标 name + publish_port
# 6. 服务器在注册表中查找 (name, publish_port)，找到本客户端
# 7. 服务器通过本客户端的 yamux 连接请求创建新 stream
# 8. 本客户端收到请求，连接到 local_port 对应的本地服务
# 9. 建立数据通道：Visitor本地应用 ↔ Visitor客户端 ↔ 服务器 ↔ 本客户端 ↔ 本地服务
# 
# 使用场景：
# - 让团队成员访问开发环境的数据库
# - 远程访问内网服务而不暴露到公网
# - 实现客户端到客户端的安全通信
# - 绕过防火墙和NAT限制
