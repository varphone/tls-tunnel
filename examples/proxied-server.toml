# =============================================================================
# tls-tunnel 服务端配置 - Nginx 反向代理模式
# =============================================================================
# 
# 使用场景：
# - 服务端部署在 Nginx 反向代理后面
# - Nginx 负责 TLS/SSL 终止和协议转换（HTTP/2 或 WebSocket）
# - tls-tunnel 服务端只需监听本地端口，专注于隧道转发
# - 适用于生产环境部署，便于集中管理证书和负载均衡
#
# 配套 Nginx 配置：examples/nginx-all-in-one.conf
# 配套客户端配置：examples/proxied-client.toml
#
# 架构说明：
# 客户端 -> Nginx:443 (HTTPS/TLS) -> tls-tunnel:3080 (HTTP/WS) -> 目标服务
#
# =============================================================================

[server]
# -----------------------------------------------------------------------------
# 网络绑定配置
# -----------------------------------------------------------------------------

# 服务器绑定地址
# - "127.0.0.1": 仅本地访问（推荐，与 Nginx 同机部署）
# - "0.0.0.0": 监听所有网络接口（不推荐，除非 Nginx 在其他机器）
# 
# 注意：使用 Nginx 反向代理时，应绑定到 127.0.0.1，避免直接暴露
bind_addr = "127.0.0.1"

# 服务器监听端口
# - 建议使用非标准端口（避免与其他服务冲突）
# - 必须与 Nginx upstream 配置中的端口一致
# - 示例：3080, 8080, 9000 等
bind_port = 3080

# -----------------------------------------------------------------------------
# 传输协议配置
# -----------------------------------------------------------------------------

# 传输类型（必须与客户端配置一致）
# - "http2": HTTP/2 CONNECT 隧道（推荐，性能更好，延迟更低）
# - "wss": WebSocket Secure（兼容性更好，适用于严格防火墙环境）
# - "tls": 直连模式（不使用代理，仅用于测试）
# 
# 注意：使用 Nginx 时，必须确保 Nginx 配置与此设置匹配
# - http2: Nginx 需要 proxy_set_header Connection ""
# - wss: Nginx 需要 proxy_set_header Upgrade/Connection "upgrade"
transport = "wss"

# -----------------------------------------------------------------------------
# 反向代理模式配置
# -----------------------------------------------------------------------------

# 反向代理模式（必须设置为 true）
# - true: 服务端不处理 TLS，只处理应用层协议（HTTP/2 或 WebSocket）
# - false: 直连模式，服务端自己处理 TLS（需要 cert_path 和 key_path）
# 
# 启用后的效果：
# - 不需要配置证书文件（cert_path 和 key_path 会被忽略）
# - 监听 HTTP 端口，由 Nginx 处理 TLS 加密
# - 减轻服务端负担，证书管理更简单
behind_proxy = true

# -----------------------------------------------------------------------------
# 认证配置
# -----------------------------------------------------------------------------

# 认证密钥（必须与客户端配置一致）
# - 用于验证客户端身份，防止未授权访问
# - 生产环境请使用长度至少 32 字符的强密码
# - 建议使用随机生成的密钥：openssl rand -base64 32
# - 客户端必须提供相同的密钥才能建立连接
auth_key = "test-secret-key-12345"

# -----------------------------------------------------------------------------
# TLS 证书配置（反向代理模式下不需要）
# -----------------------------------------------------------------------------

# 注意：在 behind_proxy = true 模式下，以下配置会被忽略
# TLS 由前端 Nginx 处理，不需要在这里配置证书

# cert_path = "examples/certs/cert.pem"  # 证书文件路径（被忽略）
# key_path = "examples/certs/key.pem"    # 私钥文件路径（被忽略）

# =============================================================================
# 配置对比：反向代理 vs 直连模式
# =============================================================================
#
# 反向代理模式（当前配置）：
# ---------------------------------------------------
# behind_proxy = true
# bind_addr = "127.0.0.1"
# bind_port = 3080
# transport = "http2" 或 "wss"
# 
# 优点：
# + 证书管理集中在 Nginx
# + 可利用 Nginx 的负载均衡、缓存等功能
# + 更容易实现多域名、多服务共存
# + 便于监控和日志管理
# 
# 适用场景：
# - 生产环境部署
# - 需要与其他 Web 服务共存
# - 需要复杂的路由规则
#
# 直连模式（不使用 Nginx）：
# ---------------------------------------------------
# behind_proxy = false
# bind_addr = "0.0.0.0"
# bind_port = 443
# transport = "tls"
# cert_path = "cert.pem"
# key_path = "key.pem"
# 
# 优点：
# + 部署简单，不需要额外的 Nginx
# + 减少一层代理，理论上延迟更低
# 
# 适用场景：
# - 测试环境
# - 简单部署
# - 专用服务器
#
# =============================================================================
# 端口转发配置说明
# =============================================================================
#
# 服务端不需要配置具体的端口转发规则
# 端口转发规则由客户端配置决定（proxies 列表）
#
# 工作流程：
# 1. 客户端连接到服务端并建立加密隧道
# 2. 客户端发送端口转发请求（publish_port, local_port）
# 3. 服务端动态监听 publish_port 并创建转发规则
# 4. 外部连接 -> 服务端:publish_port -> 隧道 -> 客户端:local_port
#
# 示例（客户端配置）：
# [[proxies]]
# name = "web"
# publish_port = 8888    # 服务端将监听此端口
# local_port = 80        # 转发到客户端的此端口
#
# =============================================================================
# 快速启动
# =============================================================================
#
# 1. 确认 Nginx 已正确配置并启动
#    - 配置文件：examples/nginx-all-in-one.conf
#    - 检查 upstream 端口与 bind_port 一致
#    - 检查 transport 类型与 Nginx location 配置匹配
#
# 2. 修改本配置：
#    - 更新 bind_port（与 Nginx upstream 一致）
#    - 设置强密码 auth_key
#    - 选择 transport 类型（http2 或 wss）
#
# 3. 启动服务端：
#    tls-tunnel server -c examples/proxied-server.toml
#
# 4. 检查启动日志：
#    - 应显示：Server started on 127.0.0.1:3080
#    - 应显示：Behind proxy mode enabled
#    - 应显示：Transport: wss (或 http2)
#
# 5. 启动客户端并测试：
#    tls-tunnel client -c examples/proxied-client.toml
#
# =============================================================================
# 故障排查
# =============================================================================
#
# 问题 1: Nginx 报 502 Bad Gateway
# - 检查服务端是否启动：netstat -an | findstr 3080
# - 检查 bind_port 与 Nginx upstream 配置是否一致
# - 检查防火墙是否阻止本地连接
#
# 问题 2: 客户端连接超时
# - 检查 Nginx 是否正常运行：curl https://localhost/
# - 检查 Nginx 日志：/var/log/nginx/error.log
# - 确认 Nginx 配置中的 location 路径正确
#
# 问题 3: 认证失败
# - 确认客户端和服务端的 auth_key 完全一致
# - 注意不要有多余的空格或换行符
# - 检查配置文件编码（应为 UTF-8）
#
# 问题 4: 传输协议不匹配
# - 服务端 transport = "wss" 时，Nginx 需要 WebSocket 配置
# - 服务端 transport = "http2" 时，Nginx 需要 HTTP/2 配置
# - 客户端的 transport 必须与服务端一致
#
# 问题 5: 端口冲突
# - 更改 bind_port 为其他未使用端口
# - 同时更新 Nginx upstream 配置
# - 重启 Nginx 和 tls-tunnel 服务端
#
# 问题 6: behind_proxy 设置错误
# - behind_proxy = true: 必须通过 Nginx 访问
# - behind_proxy = false: 客户端直连服务端，需要证书配置
# - 检查日志中的模式提示
#
# =============================================================================
# 性能优化建议
# =============================================================================
#
# 1. 传输协议选择：
#    - HTTP/2: 更高性能，更低延迟，推荐用于内部网络
#    - WSS: 更好的兼容性，适用于严格的防火墙环境
#
# 2. Nginx 优化：
#    - 增加 worker_processes 和 worker_connections
#    - 启用 keepalive 连接（已在示例配置中）
#    - 调整超时时间以匹配实际需求
#
# 3. 系统优化：
#    - 增加文件描述符限制：ulimit -n 65535
#    - 调整 TCP 参数：sysctl -w net.ipv4.tcp_tw_reuse=1
#    - 监控 CPU 和内存使用情况
#
# 4. 监控和日志：
#    - 定期检查 Nginx access.log 和 error.log
#    - 使用 RUST_LOG=info 启动以获取详细日志
#    - 监控连接数和带宽使用情况
#
# =============================================================================
# 安全建议
# =============================================================================
#
# 1. 认证密钥：
#    - 使用至少 32 字符的随机密钥
#    - 定期更换密钥（建议每季度）
#    - 不要在日志或错误信息中输出密钥
#
# 2. 网络隔离：
#    - bind_addr 使用 127.0.0.1，不要使用 0.0.0.0
#    - 配置防火墙规则，只允许必要的端口
#    - 考虑使用 VPC 或私有网络
#
# 3. TLS 配置：
#    - Nginx 使用 TLS 1.2 或更高版本
#    - 禁用弱加密套件
#    - 使用有效的证书（Let's Encrypt 或商业证书）
#
# 4. 访问控制：
#    - 限制客户端 IP（Nginx allow/deny 指令）
#    - 实施速率限制（Nginx limit_req 模块）
#    - 记录访问日志用于审计
#
# =============================================================================
