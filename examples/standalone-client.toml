# =============================================================================
# tls-tunnel 客户端配置 - 直连模式（Standalone）
# =============================================================================
# 
# 使用场景：
# - 客户端直接连接到 tls-tunnel 服务端（不通过 Nginx 等代理）
# - 适用于简单部署、测试环境、点对点连接
# - 服务端自己处理 TLS 加密和证书管理
#
# 配套服务端配置：examples/standalone-server.toml
#
# 架构说明：
# 客户端 -> tls-tunnel 服务端:3080 (TLS) -> 目标服务
#
# 与反向代理模式的区别：
# - 直连模式：客户端直接连接服务端的 TLS 端口
# - 代理模式：客户端 -> Nginx (HTTPS) -> tls-tunnel (HTTP/WS)
#
# =============================================================================

[client]
# -----------------------------------------------------------------------------
# 服务器连接配置
# -----------------------------------------------------------------------------

# 服务器地址
# - 可以是域名或 IP 地址
# - 示例：example.com, 192.168.1.100, localhost
# - 直连模式通常使用公网 IP 或域名
server_addr = "localhost"

# 服务器 TLS 端口
# - 直连模式下，服务端监听的 TLS 端口
# - 建议使用非标准端口（如 3080, 8443）避免冲突
# - 如果使用标准 443 端口，需要 root 权限启动服务端
server_port = 3080

# 服务器路径（直连模式固定为根路径）
# 注意：此配置在 tls 传输模式下不使用，仅 http2/wss 模式需要
# server_path = "/"

# -----------------------------------------------------------------------------
# 传输协议配置
# -----------------------------------------------------------------------------

# 传输类型（直连模式使用 tls）
# - "tls": 原生 TLS 加密传输（推荐用于直连模式）
# - "http2": HTTP/2 CONNECT 隧道（通常用于反向代理模式）
# - "wss": WebSocket Secure（通常用于反向代理模式）
# 
# 直连模式推荐使用 tls，性能最好，延迟最低
transport = "tls"

# -----------------------------------------------------------------------------
# TLS/SSL 配置
# -----------------------------------------------------------------------------

# 是否跳过 TLS 证书验证
# - true: 跳过验证（仅用于开发/测试环境，自签名证书）
# - false: 启用验证（生产环境必须使用，确保连接安全）
# 
# 安全提示：
# - 测试环境可以使用 skip_verify = true
# - 生产环境必须使用 skip_verify = false，并确保证书有效
skip_verify = true

# CA 证书路径（可选）
# - 当使用自签名证书且 skip_verify = false 时，需要配置此项
# - 指定 CA 证书文件的路径，用于验证服务端证书
# - 示例：ca_cert_path = "examples/certs/ca.pem"
# ca_cert_path = "ca.pem"

# -----------------------------------------------------------------------------
# 认证配置
# -----------------------------------------------------------------------------

# 认证密钥（必须与服务器配置一致）
# - 用于客户端和服务端之间的身份验证
# - 生产环境请使用长度至少 32 字符的强密码
# - 建议使用随机生成的密钥：openssl rand -base64 32
# - 注意：密钥泄露会导致未授权访问
auth_key = "xx0123456789abcdef"

# -----------------------------------------------------------------------------
# 客户端统计服务器配置（可选）
# -----------------------------------------------------------------------------

# 统计信息 HTTP 服务端口（可选）
# - 启用后可通过 HTTP 访问客户端统计信息
# - 示例：http://localhost:9091/stats (JSON)
# - 示例：http://localhost:9091/ (HTML)
# - 可以使用 `tls-tunnel top --url http://localhost:9091` 查看
# stats_port = 9091

# 统计信息绑定地址（可选）
# - 默认：0.0.0.0（监听所有接口）
# - 本地访问：127.0.0.1（仅本地可访问，更安全）
# - 示例：stats_addr = "127.0.0.1"
# stats_addr = "0.0.0.0"

# =============================================================================
# 代理配置列表
# =============================================================================
# 
# 每个 [[proxies]] 块定义一个端口转发规则
# - name: 代理名称（用于日志标识，必须唯一）
# - publish_port: 服务端监听端口（外部访问该端口）
# - local_port: 客户端本地服务端口（转发到客户端本地的该端口）
#
# 工作流程：
# 外部访问 -> 服务端:publish_port -> TLS 隧道 -> 客户端:local_port
#
# =============================================================================

# 示例 1: Web 服务代理
[[proxies]]
name = "web"                # 代理名称
publish_port = 8888         # 服务端监听 8888 端口
local_port = 80             # 转发到客户端本地 80 端口
# 使用：访问 http://server-ip:8888 -> 客户端本地 http://localhost:80

# 示例 2: SSH 服务代理
[[proxies]]
name = "ssh"                # SSH 服务
publish_port = 2222         # 服务端监听 2222 端口
local_port = 22             # 转发到客户端本地 22 端口
# 使用：ssh -p 2222 user@server-ip -> 客户端本地 ssh localhost:22

# 示例 3: 数据库代理
[[proxies]]
name = "database"           # 数据库服务
publish_port = 5432         # 服务端监听 5432 端口
local_port = 5432           # 转发到客户端本地 5432 端口
# 使用：psql -h server-ip -p 5432 -> 客户端本地数据库

# 示例 4: HTTPS 服务代理
# [[proxies]]
# name = "web-secure"
# publish_port = 8443
# local_port = 443
# 使用：https://server-ip:8443 -> 客户端本地 https://localhost:443

# 示例 5: 远程桌面代理（Windows RDP）
# [[proxies]]
# name = "rdp"
# publish_port = 3389
# local_port = 3389
# 使用：mstsc /v:server-ip:3389 -> 客户端本地 RDP

# 示例 6: MySQL 数据库
# [[proxies]]
# name = "mysql"
# publish_port = 3306
# local_port = 3306
# 使用：mysql -h server-ip -P 3306 -> 客户端本地 MySQL

# 示例 7: Redis 缓存
# [[proxies]]
# name = "redis"
# publish_port = 6379
# local_port = 6379
# 使用：redis-cli -h server-ip -p 6379 -> 客户端本地 Redis

# 示例 8: 自定义应用
# [[proxies]]
# name = "custom-app"
# publish_port = 9000
# local_port = 8080
# 使用：根据应用协议访问 server-ip:9000 -> 客户端本地 8080

# =============================================================================
# 快速启动
# =============================================================================
#
# 1. 修改配置：
#    - 更新 server_addr（服务端 IP 或域名）
#    - 更新 server_port（服务端监听端口）
#    - 更新 auth_key（与服务端保持一致）
#    - 配置需要转发的端口（proxies 列表）
#
# 2. 确认服务端已启动：
#    tls-tunnel server -c examples/standalone-server.toml
#
# 3. 启动客户端：
#    tls-tunnel client -c examples/standalone-client.toml
#
# 4. 验证连接：
#    - 查看日志输出，确认连接成功
#    - 应显示：Connected to server via tls transport
#    - 应显示：Yamux connection established
#
# 5. 测试端口转发：
#    curl http://server-ip:8888          # 测试 Web 服务
#    ssh -p 2222 user@server-ip          # 测试 SSH
#    psql -h server-ip -p 5432           # 测试数据库
#
# =============================================================================
# 故障排查
# =============================================================================
#
# 问题 1: 连接超时
# - 检查服务端是否启动：telnet server-ip 3080
# - 检查防火墙是否允许端口访问
# - 检查 server_addr 和 server_port 是否正确
# - 检查网络连通性：ping server-ip
#
# 问题 2: TLS 证书验证失败
# - 开发环境：设置 skip_verify = true
# - 生产环境：使用有效的证书或配置 ca_cert_path
# - 检查证书是否过期：openssl s_client -connect server-ip:3080
# - 确认证书中的 CN 或 SAN 与 server_addr 匹配
#
# 问题 3: 认证失败
# - 确认客户端和服务端的 auth_key 完全一致
# - 检查配置文件编码（应为 UTF-8）
# - 注意不要有多余的空格或换行符
# - 查看服务端日志获取详细错误信息
#
# 问题 4: 端口已被占用
# - 服务端端口冲突：更改 publish_port 为未使用端口
# - 客户端端口冲突：确认 local_port 对应的服务正在运行
# - 使用 netstat -an | findstr PORT 检查端口占用
#
# 问题 5: 连接成功但无法转发流量
# - 检查客户端本地服务是否运行（local_port）
# - 测试本地服务：curl http://localhost:80
# - 查看 tls-tunnel 日志是否有错误信息
# - 检查防火墙是否阻止本地连接
#
# 问题 6: 性能问题（延迟高/速度慢）
# - 检查网络质量：ping server-ip, traceroute
# - 考虑使用更近的服务器节点
# - 检查服务器和客户端的 CPU/内存使用情况
# - 启用详细日志排查瓶颈：RUST_LOG=debug
#
# =============================================================================
# 部署模式对比
# =============================================================================
#
# 直连模式（当前配置）：
# ---------------------------------------------------
# 客户端 -> 服务端 (TLS)
# 
# 优点：
# + 部署简单，只需启动服务端和客户端
# + 减少一层代理，理论上延迟更低
# + 不依赖额外的基础设施（如 Nginx）
# + 适合快速测试和小规模部署
# 
# 缺点：
# - 证书管理分散，每个服务需要单独配置
# - 无法利用 Nginx 的高级功能（负载均衡、缓存等）
# - 难以与现有 Web 服务共存（端口冲突）
# 
# 适用场景：
# - 测试和开发环境
# - 点对点的简单连接
# - 专用隧道服务器
# - 不需要复杂路由的场景
#
# 反向代理模式：
# ---------------------------------------------------
# 客户端 -> Nginx (HTTPS) -> 服务端 (HTTP/WS)
# 配置文件：proxied-client.toml + proxied-server.toml
# 
# 优点：
# + 证书管理集中在 Nginx
# + 可以利用 Nginx 的负载均衡、缓存、限流等功能
# + 支持多域名、子路径、虚拟主机
# + 便于监控和日志管理
# + 可以与其他 Web 服务共存
# 
# 缺点：
# - 需要额外部署和配置 Nginx
# - 增加一层代理，可能略微增加延迟
# - 配置相对复杂
# 
# 适用场景：
# - 生产环境部署
# - 需要与其他 Web 服务共存
# - 需要复杂的路由和负载均衡
# - 需要集中的证书和日志管理
#
# =============================================================================
# 安全建议
# =============================================================================
#
# 1. 认证密钥：
#    - 使用至少 32 字符的随机强密钥
#    - 定期更换密钥（建议每季度）
#    - 不要在代码仓库中提交真实密钥
#    - 使用环境变量或密钥管理服务存储密钥
#
# 2. TLS 证书：
#    - 生产环境必须使用有效的证书（Let's Encrypt 或商业证书）
#    - 定期检查证书过期时间
#    - 使用 TLS 1.2 或更高版本
#    - 禁用弱加密套件
#
# 3. 网络安全：
#    - 配置防火墙规则，只允许必要的端口
#    - 使用 VPN 或私有网络增强安全性
#    - 限制来源 IP（在服务端配置）
#    - 启用日志记录用于审计
#
# 4. 访问控制：
#    - 只暴露必要的端口（publish_port）
#    - 定期审查 proxies 配置
#    - 监控异常连接和流量模式
#    - 实施最小权限原则
#
# 5. 监控和维护：
#    - 定期检查日志文件
#    - 监控连接数和带宽使用
#    - 设置告警机制（连接失败、认证失败等）
#    - 保持软件版本更新
#
# =============================================================================
# 性能优化
# =============================================================================
#
# 1. 网络优化：
#    - 选择地理位置接近的服务器
#    - 使用高质量的网络连接
#    - 考虑使用 CDN 或加速服务
#
# 2. 系统优化：
#    - 增加文件描述符限制：ulimit -n 65535
#    - 调整 TCP 参数以提高性能
#    - 确保足够的 CPU 和内存资源
#
# 3. 应用优化：
#    - 合理配置代理数量，避免过多连接
#    - 考虑使用连接池技术
#    - 定期清理无用的连接
#
# 4. 监控指标：
#    - 连接建立时间
#    - 数据传输速率
#    - CPU 和内存使用率
#    - 错误率和重连次数
#
# =============================================================================
