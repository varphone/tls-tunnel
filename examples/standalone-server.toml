# =============================================================================
# tls-tunnel 服务端配置 - 直连模式（Standalone）
# =============================================================================
# 
# 使用场景：
# - 服务端直接处理 TLS 连接（不使用 Nginx 等反向代理）
# - 适用于简单部署、测试环境、专用隧道服务器
# - 服务端自己管理 TLS 证书和加密
#
# 配套客户端配置：examples/standalone-client.toml
#
# 架构说明：
# 客户端 -> tls-tunnel 服务端:3080 (TLS) -> 动态监听端口 -> 目标服务
#
# 与反向代理模式的区别：
# - 直连模式：服务端自己处理 TLS，需要配置证书（behind_proxy = false）
# - 代理模式：Nginx 处理 TLS，服务端只处理应用层协议（behind_proxy = true）
#
# =============================================================================

[server]
# -----------------------------------------------------------------------------
# 网络绑定配置
# -----------------------------------------------------------------------------

# 服务器绑定地址
# - "0.0.0.0": 监听所有网络接口（公网部署推荐）
# - "127.0.0.1": 仅本地访问（测试环境）
# - 特定IP: 监听指定网络接口（如 "192.168.1.100"）
# 
# 安全提示：
# - 公网部署时使用 0.0.0.0 或特定公网 IP
# - 本地测试时使用 127.0.0.1
# - 确保配置防火墙规则限制访问
bind_addr = "0.0.0.0"

# 服务器监听端口
# - 客户端连接到此端口建立 TLS 隧道
# - 建议使用非标准端口（如 3080, 8443）避免冲突和扫描
# - 如果使用 443 端口，Linux/Mac 需要 root 权限
# - 必须在防火墙中开放此端口
bind_port = 3080

# -----------------------------------------------------------------------------
# TLS 证书配置
# -----------------------------------------------------------------------------

# TLS 证书路径（必需，直连模式必须配置）
# - 证书文件路径，支持相对路径或绝对路径
# - 可以是自签名证书或 CA 签发的证书
# - 生成自签名证书：examples/certs/generate-cert.sh
# 
# 证书要求：
# - PEM 格式
# - 包含完整的证书链（如果有中间证书）
# - CN 或 SAN 应包含客户端使用的 server_addr
# cert_path = "examples/certs/cert.pem"

# TLS 私钥路径（必需，直连模式必须配置）
# - 私钥文件路径，支持相对路径或绝对路径
# - 必须与证书配对
# - 确保文件权限安全（建议 chmod 600）
# 
# 安全提示：
# - 私钥文件不要提交到代码仓库
# - 定期备份私钥文件
# - 如果私钥泄露，立即更换证书
# key_path = "examples/certs/key.pem"

# -----------------------------------------------------------------------------
# 传输协议配置
# -----------------------------------------------------------------------------

# 传输类型（直连模式使用 tls）
# - "tls": 原生 TLS 加密传输（推荐用于直连模式）
# - "http2": HTTP/2 CONNECT 隧道（通常用于反向代理模式）
# - "wss": WebSocket Secure（通常用于反向代理模式）
# 
# 直连模式推荐使用 tls，具有以下优势：
# - 性能最好，延迟最低
# - 不需要额外的协议开销
# - 原生支持，兼容性好
transport = "tls"

# -----------------------------------------------------------------------------
# 认证配置
# -----------------------------------------------------------------------------

# 认证密钥（必须与客户端配置一致）
# - 用于验证客户端身份，防止未授权访问
# - 生产环境请使用长度至少 32 字符的强密码
# - 建议使用随机生成的密钥：openssl rand -base64 32
# - 客户端必须提供相同的密钥才能建立连接
# 
# 安全建议：
# - 不要使用默认值或简单密码
# - 定期更换密钥（建议每季度）
# - 不同的部署环境使用不同的密钥
# - 使用环境变量或密钥管理服务存储
auth_key = "test-secret-key-12345"

# -----------------------------------------------------------------------------
# Forward Proxy 配置（可选）
# -----------------------------------------------------------------------------

# 是否允许 forward proxy 功能（HTTP/SOCKS5 代理）
# - true: 允许客户端使用 forwarder 功能，连接到外部目标
# - false: 禁用 forward proxy，客户端只能使用 proxy 和 visitor 功能
# 
# 注意事项：
# - 启用此功能后，客户端可以通过服务器转发任意流量到外部
# - 生产环境请谨慎启用，建议配合防火墙和流量监控
# - 默认值为 false（禁用）
allow_forward = true

# -----------------------------------------------------------------------------
# 统计信息端口（可选）
# -----------------------------------------------------------------------------

# HTTP 统计信息服务器端口
# - 启用后可通过浏览器访问 http://server-ip:stats_port 查看统计信息
# - 显示每个代理的连接数、流量、运行时间等信息
# - JSON API 端点: http://server-ip:stats_port/stats
# - 注释掉或删除此配置则不启动统计服务器
# 
# HTTP 统计信息服务器绑定地址（可选）
# - 未配置时，默认使用 bind_addr 的值
# - "127.0.0.1": 仅本地访问（推荐用于生产环境）
# - "0.0.0.0": 允许外部访问（需配合防火墙使用）
# 
# 安全提示：
# - 此端口未加密，建议仅在内网使用或通过防火墙限制访问
# - 生产环境建议使用 127.0.0.1 只允许本地访问，然后通过 SSH 隧道查看
# 
# 示例：
# stats_port = 9090
# stats_addr = "127.0.0.1"  # 未设置时默认使用 bind_addr
# 
# 访问方式：
# - HTML 界面: http://server-ip:9090
# - JSON API: http://server-ip:9090/stats
#stats_port = 9090
#stats_addr = "127.0.0.1"

# -----------------------------------------------------------------------------
# 代理模式配置
# -----------------------------------------------------------------------------

# 反向代理模式开关（直连模式必须为 false）
# - false: 直连模式，服务端自己处理 TLS（需要 cert_path 和 key_path）
# - true: 反向代理模式，前端代理处理 TLS（不需要证书配置）
# 
# 当前配置为直连模式：
# - 服务端监听 TLS 端口，自己处理加密
# - 需要配置有效的证书和私钥
# - 客户端直接连接到此服务端
behind_proxy = false

# -----------------------------------------------------------------------------
# 速率限制配置（可选）
# -----------------------------------------------------------------------------

# 速率限制器配置（防止滥用和DoS攻击）
# - 基于 Token Bucket 算法
# - 未配置时使用默认值，注释掉则禁用速率限制
# 
# [server.rate_limit]
# # 每秒允许的最大请求数
# # - 控制新连接建立的速率
# # - 超出限制的连接将被延迟或拒绝
# # - 默认值：100 req/s
# requests_per_second = 100
# 
# # 突发流量允许的最大请求数
# # - 允许短时间内超过 requests_per_second 的流量
# # - 适应正常的流量波动
# # - 建议设置为 requests_per_second 的 2-3 倍
# # - 默认值：200
# burst_size = 200
# 
# 使用建议：
# - 开发环境：设置较高的值或禁用（注释掉）
# - 生产环境：根据实际负载调整，建议启用
# - 如遇频繁限流告警，适当增大 burst_size
# - 如遇 DoS 攻击，适当降低 requests_per_second

# -----------------------------------------------------------------------------
# 请求大小限制配置（可选）
# -----------------------------------------------------------------------------

# 请求大小限制器配置（防止内存耗尽攻击）
# - 限制单个请求的最大大小
# - 未配置时使用默认值，注释掉则使用默认值
# 
# [server.size_limits]
# # 单个请求的最大大小（字节）
# # - 包括请求头和请求体
# # - 超出限制的请求将被拒绝
# # - 默认值：1048576 (1 MB)
# max_request_size = 1048576
# 
# # 请求头的最大大小（字节）
# # - 仅包括 HTTP 请求头
# # - 防止超大请求头攻击
# # - 默认值：8192 (8 KB)
# max_header_size = 8192
# 
# 使用建议：
# - 根据实际应用场景调整
# - 如果需要传输大文件，适当增大 max_request_size
# - 通常请求头不应超过 8KB，除非有特殊需求
# - 设置过小可能导致正常请求被拒绝
# - 设置过大可能导致内存耗尽攻击

# =============================================================================
# 端口转发工作机制
# =============================================================================
#
# 服务端不需要预先配置端口转发规则，而是动态响应客户端请求：
#
# 1. 客户端连接建立：
#    - 客户端连接到 bind_addr:bind_port
#    - TLS 握手和身份验证（auth_key）
#    - 建立加密的 Yamux 多路复用连接
#
# 2. 端口转发请求：
#    - 客户端发送端口转发请求（publish_port, local_port）
#    - 服务端动态监听 publish_port
#    - 创建从 publish_port 到客户端 local_port 的转发规则
#
# 3. 流量转发：
#    外部连接 -> 服务端:publish_port -> 加密隧道 -> 客户端:local_port
#
# 示例（客户端配置）：
# [[proxies]]
# name = "web"
# publish_port = 8888    # 服务端将动态监听此端口
# local_port = 80        # 转发到客户端的 80 端口
#
# 流程：curl http://server-ip:8888 -> 隧道 -> 客户端 localhost:80
#
# =============================================================================
# 证书管理
# =============================================================================
#
# 1. 使用自签名证书（开发/测试）：
#    生成证书：
#    cd examples/certs
#    ./generate-cert.sh    # Linux/Mac
#    ./generate-cert.ps1   # Windows
#
#    配置：
#    cert_path = "examples/certs/cert.pem"
#    key_path = "examples/certs/key.pem"
#
#    客户端配置：
#    skip_verify = true    # 跳过证书验证
#
# 2. 使用 Let's Encrypt 证书（生产环境）：
#    安装 certbot：
#    sudo apt install certbot    # Ubuntu/Debian
#    
#    获取证书：
#    sudo certbot certonly --standalone -d yourdomain.com
#    
#    配置：
#    cert_path = "/etc/letsencrypt/live/yourdomain.com/fullchain.pem"
#    key_path = "/etc/letsencrypt/live/yourdomain.com/privkey.pem"
#    
#    客户端配置：
#    skip_verify = false   # 启用证书验证
#    server_addr = "yourdomain.com"
#
#    自动续期：
#    sudo certbot renew --post-hook "systemctl restart tls-tunnel"
#
# 3. 使用商业证书：
#    从证书颁发机构购买证书
#    下载完整证书链和私钥
#    配置证书路径并重启服务
#
# 4. 证书安全：
#    - 私钥权限：chmod 600 key.pem
#    - 定期检查过期：openssl x509 -in cert.pem -noout -dates
#    - 备份证书和私钥
#    - 使用强加密算法（RSA 2048+ 或 ECC）
#
# =============================================================================
# 快速启动
# =============================================================================
#
# 1. 生成证书（如果还没有）：
#    cd examples/certs
#    ./generate-cert.sh           # Linux/Mac
#    ./generate-cert.ps1          # Windows
#
# 2. 修改配置：
#    - 设置 bind_addr（通常为 0.0.0.0）
#    - 设置 bind_port（建议非标准端口）
#    - 配置 cert_path 和 key_path
#    - 设置强密码 auth_key
#
# 3. 配置防火墙：
#    sudo ufw allow 3080/tcp      # Ubuntu
#    sudo firewall-cmd --add-port=3080/tcp --permanent  # CentOS
#    netsh advfirewall firewall add rule name="tls-tunnel" dir=in action=allow protocol=TCP localport=3080  # Windows
#
# 4. 启动服务端：
#    tls-tunnel server -c examples/standalone-server.toml
#
# 5. 检查启动日志：
#    - 应显示：Server started on 0.0.0.0:3080
#    - 应显示：Transport: tls
#    - 应显示：TLS certificates loaded
#
# 6. 测试 TLS 连接：
#    openssl s_client -connect localhost:3080
#    # 应该能建立 TLS 连接
#
# 7. 启动客户端并测试：
#    tls-tunnel client -c examples/standalone-client.toml
#
# =============================================================================
# 故障排查
# =============================================================================
#
# 问题 1: 端口已被占用
# - 错误：Address already in use
# - 解决：更改 bind_port 为其他未使用端口
# - 检查：netstat -an | findstr 3080 (Windows)
#        netstat -tuln | grep 3080 (Linux)
#
# 问题 2: 证书文件未找到
# - 错误：No such file or directory
# - 解决：检查 cert_path 和 key_path 是否正确
# - 确认：使用绝对路径或相对于执行目录的路径
# - 生成：cd examples/certs && ./generate-cert.sh
#
# 问题 3: 证书和私钥不匹配
# - 错误：Private key does not match certificate
# - 解决：确保 cert.pem 和 key.pem 是配对的
# - 验证：openssl x509 -noout -modulus -in cert.pem | openssl md5
#        openssl rsa -noout -modulus -in key.pem | openssl md5
#        两个 MD5 值应该相同
#
# 问题 4: 权限不足（443 端口）
# - 错误：Permission denied
# - 原因：Linux/Mac 上绑定 1024 以下端口需要 root 权限
# - 解决：使用 sudo 启动，或使用非特权端口（>1024）
# - 推荐：使用 3080 等非特权端口，避免 root 权限运行
#
# 问题 5: 防火墙阻止连接
# - 症状：客户端连接超时
# - 检查：telnet server-ip 3080
# - 解决：配置防火墙规则允许 bind_port
# - Linux：sudo ufw allow 3080/tcp
# - Windows：netsh advfirewall firewall add rule...
#
# 问题 6: 客户端证书验证失败
# - 错误：Certificate verification failed
# - 原因：自签名证书不被信任
# - 解决：客户端设置 skip_verify = true（测试环境）
# - 或者：配置 ca_cert_path 指向 CA 证书
# - 生产：使用有效的 CA 签发证书
#
# 问题 7: 连接建立后立即断开
# - 检查：auth_key 是否与客户端一致
# - 查看：服务端日志中的认证错误信息
# - 确认：auth_key 没有多余空格或特殊字符
#
# 问题 8: 性能问题
# - 检查：CPU 和内存使用情况
# - 监控：连接数和带宽使用
# - 优化：增加系统资源限制（ulimit -n）
# - 调试：使用 RUST_LOG=debug 查看详细日志
#
# =============================================================================
# 生产环境部署建议
# =============================================================================
#
# 1. 系统服务配置（systemd）：
#    创建 /etc/systemd/system/tls-tunnel.service：
#    
#    [Unit]
#    Description=TLS Tunnel Server
#    After=network.target
#    
#    [Service]
#    Type=simple
#    User=tls-tunnel
#    Group=tls-tunnel
#    WorkingDirectory=/opt/tls-tunnel
#    ExecStart=/usr/local/bin/tls-tunnel server -c /etc/tls-tunnel/server.toml
#    Restart=on-failure
#    RestartSec=5s
#    
#    # 安全加固
#    NoNewPrivileges=true
#    PrivateTmp=true
#    ProtectSystem=strict
#    ProtectHome=true
#    ReadWritePaths=/var/log/tls-tunnel
#    
#    [Install]
#    WantedBy=multi-user.target
#    
#    启用：
#    sudo systemctl daemon-reload
#    sudo systemctl enable tls-tunnel
#    sudo systemctl start tls-tunnel
#
# 2. 日志管理：
#    - 使用 systemd journal：journalctl -u tls-tunnel -f
#    - 或重定向到文件：ExecStart=... >> /var/log/tls-tunnel.log 2>&1
#    - 配置日志轮转：logrotate
#
# 3. 监控和告警：
#    - 监控服务状态：systemctl status tls-tunnel
#    - 监控端口：netstat -tuln | grep 3080
#    - 设置告警：使用 Prometheus + Grafana 或其他监控工具
#    - 关键指标：连接数、流量、错误率、重启次数
#
# 4. 备份和恢复：
#    - 备份配置文件：/etc/tls-tunnel/
#    - 备份证书和私钥：/etc/letsencrypt/ 或自定义路径
#    - 备份认证密钥（加密存储）
#    - 定期测试恢复流程
#
# 5. 安全加固：
#    - 使用非 root 用户运行（创建专用用户）
#    - 限制文件权限：chmod 600 key.pem, chmod 640 config.toml
#    - 配置 SELinux/AppArmor 策略
#    - 启用防火墙并限制来源 IP
#    - 定期更新软件版本
#    - 使用强密钥（32+ 字符随机字符串）
#
# 6. 高可用性：
#    - 使用多个服务器实例
#    - 配置负载均衡器（如 HAProxy）
#    - 实施健康检查
#    - 准备故障转移方案
#
# =============================================================================
# 性能优化
# =============================================================================
#
# 1. 系统参数调优：
#    # 增加文件描述符限制
#    ulimit -n 65535
#    
#    # 编辑 /etc/security/limits.conf
#    * soft nofile 65535
#    * hard nofile 65535
#    
#    # TCP 参数优化（/etc/sysctl.conf）
#    net.core.somaxconn = 1024
#    net.ipv4.tcp_max_syn_backlog = 2048
#    net.ipv4.tcp_tw_reuse = 1
#    net.ipv4.tcp_fin_timeout = 30
#    net.ipv4.ip_local_port_range = 10000 65000
#    
#    应用：sudo sysctl -p
#
# 2. 应用层优化：
#    - 使用 release 模式编译（cargo build --release）
#    - 考虑使用多个服务实例
#    - 合理配置客户端连接数
#    - 定期清理空闲连接
#
# 3. 网络优化：
#    - 使用高质量的网络连接
#    - 考虑使用专线或 VPN
#    - 优化路由选择
#    - 监控网络延迟和丢包
#
# 4. 监控指标：
#    - CPU 使用率（目标 < 70%）
#    - 内存使用量
#    - 网络带宽使用率
#    - 并发连接数
#    - 请求响应时间
#    - 错误率和重试次数
#
# =============================================================================
# 安全最佳实践
# =============================================================================
#
# 1. 认证和授权：
#    - 使用强随机密钥（openssl rand -base64 32）
#    - 为不同客户端使用不同密钥（如果可能）
#    - 定期轮换密钥
#    - 使用密钥管理服务（如 HashiCorp Vault）
#
# 2. 传输加密：
#    - 使用 TLS 1.2 或更高版本
#    - 配置强加密套件
#    - 禁用已知漏洞的协议（SSLv3, TLS 1.0/1.1）
#    - 定期更新 TLS 配置
#
# 3. 证书管理：
#    - 生产环境使用 CA 签发的证书
#    - 监控证书过期时间
#    - 自动化证书续期（Let's Encrypt）
#    - 使用证书固定（Certificate Pinning）提高安全性
#
# 4. 网络安全：
#    - 配置防火墙限制访问
#    - 使用 VPN 或私有网络
#    - 实施 IP 白名单（如果可能）
#    - 启用 DDoS 防护
#
# 5. 访问控制：
#    - 限制服务端口暴露
#    - 使用最小权限原则
#    - 审计访问日志
#    - 监控异常行为
#
# 6. 应急响应：
#    - 准备安全事件响应计划
#    - 定期备份关键数据
#    - 测试恢复流程
#    - 保持联系方式更新
#
# =============================================================================
