# Nginx 综合配置 - tls-tunnel 传输方式切换
# 场景：HTTP/2 根目录 | HTTP/2 子目录 | WSS 根目录 | WSS 子目录
# 使用：取消注释对应的 location 块

upstream tls_tunnel {
    server 127.0.0.1:3080;
    keepalive 32;
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name localhost;

    ssl_certificate certs/cert.pem;
    ssl_certificate_key certs/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # ========================================================================
    # 场景 1: 根目录模式 (server_path="/")
    # ========================================================================
    # HTTP/2: transport="http2", 使用下面的 Connection ""
    # WSS: transport="wss", 使用下面的 Upgrade 和 Connection "upgrade"
    
    location / {
        proxy_pass http://tls_tunnel;
        proxy_http_version 1.1;
        
        # HTTP/2 使用这个:
        # proxy_set_header Connection "";
        
        # WSS 使用这两个:
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        send_timeout 3600s;
        
        proxy_set_header Host $host;
        proxy_connect_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;
        proxy_buffering off;
        client_max_body_size 0;
    }

    # ========================================================================
    # 场景 2: 子目录模式 (server_path="/tunnel/")
    # ========================================================================
    # 取消下面的注释以启用子目录模式
    # HTTP/2: transport="http2", 使用 Connection ""
    # WSS: transport="wss", 使用 Upgrade 和 Connection "upgrade"
    
    # location / {
    #     root /var/www/html;
    #     index index.html;
    # }
    # 
    # location /tunnel/ {
    #     proxy_pass http://tls_tunnel/;
    #     proxy_http_version 1.1;
    #     
    #     # HTTP/2 使用这个:
    #     # proxy_set_header Connection "";
    #     
    #     # WSS 使用这两个:
    #     # proxy_set_header Upgrade $http_upgrade;
    #     # proxy_set_header Connection "upgrade";
    #     # send_timeout 3600s;
    #     
    #     proxy_set_header Host $host;
    #     proxy_connect_timeout 3600s;
    #     proxy_send_timeout 3600s;
    #     proxy_read_timeout 3600s;
    #     proxy_buffering off;
    #     client_max_body_size 0;
    # }

    # access_log /var/log/nginx/tls-tunnel-access.log;
    # error_log /var/log/nginx/tls-tunnel-error.log;
}

# ============================================================================
# HTTP 到 HTTPS 重定向（可选）
# ============================================================================

server {
    listen 80;
    listen [::]:80;
    server_name localhost;
    
    # 重定向所有 HTTP 请求到 HTTPS
    return 301 https://$host$request_uri;
}

# ============================================================================
# 配置说明
# ============================================================================
#
# 当前配置：场景 1（根目录 + WSS）
#
# 切换场景：
# 1. 根目录模式: 启用第一个 location / 块
# 2. 子目录模式: 注释掉第一个 location / 块，启用场景 2 的两个 location 块
#
# 切换传输方式：
# - HTTP/2: 使用 Connection "" 头，注释掉 Upgrade 相关头
# - WSS: 使用 Upgrade 和 Connection "upgrade" 头，注释掉 Connection ""
#
# ============================================================================
# tls-tunnel 配置
# ============================================================================
#
# 服务端 (所有场景相同):
# ---------------------------------------------------
# [server]
# bind_addr = "127.0.0.1"
# bind_port = 2080
# transport = "http2" 或 "wss"
# behind_proxy = true
# auth_key = "your-secret-key"
#
# 客户端:
# ---------------------------------------------------
# [client]
# server_addr = "localhost"
# server_port = 443
# server_path = "/" 或 "/tunnel/"  # 根据场景选择
# transport = "http2" 或 "wss"    # 与服务端保持一致
# skip_verify = false
# auth_key = "your-secret-key"
#